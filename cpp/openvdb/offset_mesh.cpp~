#include <openvdb/openvdb.h>
#include <openvdb/tools/MeshToVolume.h>
#include <openvdb/tools/VolumeToMesh.h>

#include <cmath>
#include <vector>

namespace loopsolid {

void offsetMesh(
    const std::vector<openvdb::Vec3s>& inVerts,
    const std::vector<openvdb::Vec3I>& inTris,
    float offset,
    float voxelSize,
    std::vector<openvdb::Vec3s>& outVerts,
    std::vector<openvdb::Vec3I>& outTris)
{
    openvdb::initialize();

    if (voxelSize <= 0.0f) {
        voxelSize = std::abs(offset) / 3.0f;
    }
    float halfWidth = 3.0f;

    auto transform =
        openvdb::math::Transform::createLinearTransform(voxelSize);

    auto sdf =
        openvdb::tools::meshToSignedDistanceField<openvdb::FloatGrid>(
            *transform, inVerts, inTris, {}, halfWidth, halfWidth);

    for (auto it = sdf->beginValueOn(); it; ++it) {
        it.setValue(*it - offset);
    }

    std::vector<openvdb::Vec4I> outQuads;
    openvdb::tools::volumeToMesh(*sdf, outVerts, outTris, outQuads, 0.0, 0.0, false);

    if (!outQuads.empty()) {
        outTris.reserve(outTris.size() + outQuads.size() * 2);
        for (const auto& q : outQuads) {
            outTris.emplace_back(q[0], q[1], q[2]);
            outTris.emplace_back(q[0], q[2], q[3]);
        }
    }
}

} // namespace loopsolid
